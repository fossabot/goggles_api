version: v1.0
name: Goggles API
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
global_job_config:
  prologue:
    commands:
      - checkout
      # - cache restore
      - sem-version ruby 2.6.3
      - sem-service start mysql
      - cp config/database.semaphore_2.yml config/database.yml
      - 'curl -L -o db/dump/test.sql.bz2 "https://github.com/steveoro/goggles_admin/raw/master/db/dump/development.sql.bz2"'
      - gem i bundler
      - bundle install
      - mkdir -pv tmp
      # - cache store
      - 'RAILS_ENV=test bin/rails db:rebuild from=test to=test'
      - 'RAILS_ENV=test bin/rails db:migrate'
blocks:
  - name: Code scanning
    dependencies: []
    task:
      jobs:
        - name: check style + security
          commands:
            - bundle exec rubocop
            - bundle exec brakeman -A6q
  - name: RSpec tests
    dependencies:
      - Code scanning
    task:
      jobs:
        - name: RSpec - models
          commands:
            - 'bundle exec rspec -t type:model'
        - name: RSpec - strategies
          commands:
            - 'bundle exec rspec -t type:strategy'
        - name: RSpec - validators
          commands:
            - 'bundle exec rspec -t type:validator'
        - name: RSpec - decorators
          commands:
            - 'bundle exec rspec -t type:decorator'
        - name: RSpec - commands
          commands:
            - 'bundle exec rspec -t type:command'
        - name: RSpec - API/requests
          commands:
            - 'bundle exec rspec -t type:request'
        - name: RSpec - controllers
          commands:
            - 'bundle exec rspec -t type:controller'
        - name: RSpec - views
          commands:
            - 'bundle exec rspec -t type:view'
